const mockJson = {
    "status": "ok",
    "event": {
        "id": "63fa43d5a1aea4de5c11cba74775386a10425ba6f3ed620460289edef12813cc",
        "pubkey": "99bb2d7685c879c27742a435b90f0f47915fe617058e6ac0d25d9ee514a88a6c",
        "created_at": 1711852434,
        "kind": 1111,
        "tags": [["c", "dephy"], ["dephy_to", "did:dephy:0x0000000000000000000000000000000000000000"], ["dephy_from", "did:dephy:0xbaedb1bb8646e4a89859e98405e9dc91b99826e3"], ["dephy_edge", "did:dephy:0xdafe38719e73ef401a78d0933323e63c0a0bd882"]],
        "content": "3WP34FT518LxQcseD2DKcV5wjVvEZtpZCiocwD7jySYdwGAH5aTkXiaBCgjtST2zvmmHySjPNTsDKi9fq3utvXNBBuyhcKAHvAXu52PEhk2ZxxFGgWjGvJEZhJT6K1LKzLAtZXf2JJ2JipXXFs3P8dVy8tehp6XMypKjPt7r333PWtWk1Uk343dZUwFHFNWhFEKjZ8kNNS2MPg8eG2ue2ai6GmKTJ7Vk5twLWdzjNvZh26uTp83ozJh9rjzwfytLBjEuD1i2jACcfDpARCBPw4MuoKXf1NUFY6DJo66UcV13WM2vZsciUNi5ZYb8YEdDtcyR3Q2KCVV",
        "sig": "5aea4a992eae8e5f084a85bc5e8ba5a72032ad961aa3e63af7dd279a21175668ed062436d735ebbcbc98c6f6cefd79bfab388da99f72bd197a6755d0ddaf743c"
    },
    "extra": {
        "topic": "9c22ff5f21f0b81b113e63f7db6da94fedef11b2119b4088b89664fb9a3cb658",
        "session": "test",
        "latest": {"id": "63fa43d5a1aea4de5c11cba74775386a10425ba6f3ed620460289edef12813cc", "created_at": 1711852434},
        "root_hash": "c095a4cff99d2715846b3fe52cf3b531f09c898ef2bd2973c46ee51021999d85",
        "inclusion_proof": [{
            "reduce": 0,
            "hash": "cdb8fc7fb2054884879af86139ada2ace1bcfc36737cbe00ac90c25160c08aed",
            "is_path": false
        }, {
            "reduce": 0,
            "hash": "b08ef53a9e1d26db238b1e7a736a6447238d658e0dc53e11e2d236ba2219fc27",
            "is_path": false
        }, {
            "reduce": 0,
            "hash": "802608876fb153a666e960aed95f4962359e652a6914430979a21c70e91d33b6",
            "is_path": false
        }, {
            "reduce": 0,
            "hash": "b3544ec980877c7cf970fa6cdc1ff7bfa0eba7646db79667c00687a01f004b8f",
            "is_path": false
        }, {
            "reduce": 0,
            "hash": "ad4f1e8c91167c52033e009ebabd1db6bee8c277366e4cbcd787c0180f3fc5b8",
            "is_path": false
        }, {
            "reduce": 0,
            "hash": "66fadf02ea707cc0880f52ecc0d64aae6274233981daa1c1bf4fc62f4e06eaab",
            "is_path": false
        }, {
            "reduce": 0,
            "hash": "26b3068b77d42caca76a9495e4a45b4d109d35c5b59f27fcec6159e4b152e09b",
            "is_path": false
        }, {
            "reduce": 0,
            "hash": "69133e71d85cd7da2a0d3f5278d9bfc3e0fe321a55c482a145761aa8f140c57e",
            "is_path": false
        }, {
            "reduce": 0,
            "hash": "6271f2e21d2237326b335027d745067bea396428f2d40548c726fdbd26b5a489",
            "is_path": false
        }, {
            "reduce": 0,
            "hash": "2feddef86f4795bde1a845457793a77cc30dc4eeb123891074a93693c9d2e480",
            "is_path": false
        }, {
            "reduce": 0,
            "hash": "63fa43d5a1aea4de5c11cba74775386a10425ba6f3ed620460289edef12813cc",
            "is_path": true
        }, {
            "reduce": 1,
            "hash": "e2724cf5c6fb2e24429ae579cfc490effa3cd98c504fd94e0ae2a8ce669dfdff",
            "is_path": true
        }, {
            "reduce": 1,
            "hash": "2e9951e2a0a044286c68ffd40cd34f598894a9773229b58beeb2f0b08f9d72c7",
            "is_path": true
        }, {
            "reduce": 2,
            "hash": "0349416dba8c331af8070c483ec10d005e95354a7ae92f84a34d163ee34e1624",
            "is_path": true
        }, {
            "reduce": 2,
            "hash": "85129b3057b5209de57f878e014b2aba519542221d9c670a69e319b7acc9c06d",
            "is_path": true
        }, {
            "reduce": 1,
            "hash": "be2ecc5d25c7858fc7602ef3b1840743b0f9c9c940032c313f54d1946cc1b9f9",
            "is_path": true
        }, {
            "reduce": 2,
            "hash": "36ec4a9b5b8afa3811ea9fd1bd9bb8f044911cdd317a002e47e36513bc21c054",
            "is_path": true
        }, {
            "reduce": 1,
            "hash": "fbfa139b7c6489b1b8bd537f5bdbb9174a758ae4fddff9681851ce2d3fdec9c1",
            "is_path": true
        }, {
            "reduce": 2,
            "hash": "640dfdb2df5b661b0949303dc435a845fed648b3d00cb04e41094d5589346cda",
            "is_path": true
        }, {
            "reduce": 2,
            "hash": "add46f8c0ffa9349735a275356b97b296f210a52bc7bafffeb9262b8f4e5957b",
            "is_path": true
        }, {
            "reduce": 2,
            "hash": "1a946810f85ce911ed779030947b087e9819c91e1d2c75b6fea7325af46fd89e",
            "is_path": true
        }, {
            "reduce": 1,
            "hash": "1604a8db7fa12af3efb598e7304f4f49bd347b9cc2921559dfd4dc338a03a33f",
            "is_path": true
        }, {
            "reduce": 2,
            "hash": "3184dbf810edd47a5cf31b4c707d1b7b4e1e3408c8104b935483faa90fb18cb7",
            "is_path": true
        }, {
            "reduce": 2,
            "hash": "0eceb7b812a18e0f3035780dd74bf7a6ab45750d2281cc5482ef2f7b21b79eea",
            "is_path": true
        }, {
            "reduce": 2,
            "hash": "61051c58fc907042d873b0ece15456158033177ea0f07dba624d312b3fcbb88d",
            "is_path": true
        }, {
            "reduce": 1,
            "hash": "ef79a68543c75114c3c244e8248b2088080d85d0d813d9a798e815dd0965a99b",
            "is_path": true
        }, {
            "reduce": 2,
            "hash": "c095a4cff99d2715846b3fe52cf3b531f09c898ef2bd2973c46ee51021999d85",
            "is_path": true
        }]
    }
}

import { assert } from "https://deno.land/std/assert/mod.ts";
import { keccak256 } from "npm:ethereum-cryptography/keccak.js"
import { bytesToHex } from "npm:@ethereumjs/util";

const rootHash = mockJson.extra.root_hash
const inclusionProof = mockJson.extra.inclusion_proof

const stack = []
for (const elem of inclusionProof) {
    const hash = elem.hash
    const reduce = elem.reduce
    // const is_path = elem.is_path
    assert(stack.length >= reduce)
    if (reduce > 0) {
        const children = stack.splice(-reduce)
        const expectation = bytesToHex(keccak256(new TextEncoder().encode("\x01" + children.join("")))).slice(2)
        assert(expectation === hash)
    }
    stack.push(hash)
}
assert(stack.length === 1)
assert(stack[0] === rootHash)

console.log("Inclusion proof verified")
